name: Roomba

on:
  workflow_call:
  push:
    branches:
      - roomba

concurrency: roomba_workflow

jobs:
  Cleanup-Time:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Cleaning up earlier workflows that is still waiting for approval 🧹"
      - name: Retrieve earlier workflows that are still pending review 👀
        id: find-pending-workflows
        uses: actions/github-script@v6
        with:
          script: |
            const response = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "github-actions-demo.yml",
              status: "waiting"
            })

            const currentRunNumberAsString = ${{github.run_number}}
            const currentRunNumber = parseInt(currentRunNumberAsString)

            const earlier_workflows = response.data.workflow_runs.filter(run => {
              return currentRunNumber > run.run_number
            }).map(run => {
              return {id: run.id, run_number: run.run_number}
            })

            const result = { count: earlier_workflows.length, workflows: earlier_workflows}
            console.log(`Found ${result.count} earlier workflows still pending.`)
            console.log(`Result: ${JSON.stringify(result)}`)
            return result
      - name: Rejecting found workflows from previous step 🙅🏻‍♀️
        if: ${{ steps.find-pending-workflows.outputs.result.count > 0 }}
        uses: actions/github-script@v6
        with:
          script: |
            const workflowsToReject = ${{steps.find-pending-workflows.outputs.result}}
            for (const run of workflowsToReject) {
              console.log("Rejecting earlier run with number=${run.run_number} and id=${run.id}...")
              await github.rest.actions.reviewPendingDeploymentsForRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id,
                environment_ids: [637406852],
                state: "rejected",
                comment: "Rejected automatically because a later workflow (${{github.run_number}}) has been triggered.",
              });
              console.log("Run with number=${run.run_number} successfully rejected.")
            }
      - run: echo "No earlier workflows pending approval found! 🎬"
        if: ${{ steps.find-pending-workflows.outputs.result.count == 0 }}